<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Plantilla Producción Gabarró</title>
  <!-- Librería para Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Iconos (Lucide) para un look más moderno -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    :root {
      --primary: #6AAB64;
      --primary-dark: #4e8549;
      --secondary: #2c3e50;
      --bg-color: #f3f4f6;
      --white: #ffffff;
      --border: #e5e7eb;
      --danger: #ef4444;
      --text: #1f2937;
      --input-bg: #f9fafb;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text);
      padding-bottom: 80px; /* Espacio para botones flotantes en móvil */
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* --- CABECERA --- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--white);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .brand h1 {
      font-size: 1.5rem;
      color: var(--primary);
      font-weight: 800;
      letter-spacing: -0.5px;
    }
    .brand p {
      font-size: 0.95rem;
      color: #6b7280;
      font-weight: 500;
    }

    .order-type {
      display: flex;
      gap: 10px;
      background: var(--bg-color);
      padding: 5px;
      border-radius: 8px;
    }

    .radio-label {
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .radio-label input {
      display: none;
    }

    .radio-label:has(input:checked) {
      background: var(--primary);
      color: white;
      box-shadow: 0 2px 4px rgba(106, 171, 100, 0.3);
    }

    /* --- FORMULARIO CLIENTE --- */
    .card {
      background: var(--white);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--secondary);
    }

    .grid-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 5px;
      color: #4b5563;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--input-bg);
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
    }

    /* --- BARRA DE ESTADISTICAS (Modificada) --- */
    .stats-container {
      margin-bottom: 15px;
    }

    .stats-bar {
      background: var(--secondary);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      flex-wrap: wrap;
      gap: 10px;
    }

    .stats-values {
      display: flex;
      gap: 15px;
      font-weight: bold;
      flex-wrap: wrap;
    }

    /* --- TABLA RESPONSIVE --- */
    .table-responsive {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    /* Estilos Desktop (por defecto) */
    .table-responsive thead th {
      background: var(--secondary);
      color: white;
      padding: 12px;
      text-align: left;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .table-responsive thead th:first-child { border-top-left-radius: 8px; }
    .table-responsive thead th:last-child { border-top-right-radius: 8px; }

    .table-responsive tbody tr {
      background: var(--white);
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
    }
    
    .table-responsive tbody tr:hover {
      background: #f8fafc;
    }

    .table-responsive td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }

    .table-responsive input, 
    .table-responsive select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.95rem;
    }

    .btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .btn-delete { color: var(--danger); }
    .btn-delete:hover { background: #fee2e2; }
    .btn-copy { color: var(--secondary); }
    .btn-copy:hover { background: #e2e8f0; }

    /* --- MOBILE CARD VIEW --- */
    @media (max-width: 768px) {
      .table-responsive thead {
        display: none;
      }
      
      .table-responsive tbody tr {
        display: block;
        background: var(--white);
        margin-bottom: 15px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 15px;
        border: 1px solid var(--border);
      }

      .table-responsive td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: none;
        padding: 8px 0;
        text-align: right;
      }

      .table-responsive td::before {
        content: attr(data-label);
        font-weight: 700;
        font-size: 0.85rem;
        color: #6b7280;
        text-align: left;
        margin-right: 15px;
        flex: 1;
      }

      .table-responsive td input,
      .table-responsive td select {
        width: 60%; /* Input takes 60% on mobile row */
      }

      .table-responsive td:last-child {
        border-top: 1px solid var(--border);
        padding-top: 10px;
        margin-top: 5px;
        justify-content: flex-end;
        gap: 10px;
      }
      
      .table-responsive td:last-child::before {
        display: none;
      }

      /* Ajustes barra stats móvil */
      .stats-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .stats-values {
        width: 100%;
        justify-content: space-between;
        font-size: 0.9rem;
      }
    }

    /* --- BOTONES DE ACCIÓN --- */
    .action-bar {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: space-between;
      align-items: center;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.1s, box-shadow 0.2s;
    }
    
    .btn:active { transform: scale(0.98); }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 6px rgba(106, 171, 100, 0.4);
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--secondary);
      color: var(--secondary);
    }

    .btn-danger {
      background: #fee2e2;
      color: var(--danger);
    }

    /* Leyenda Modal/Toggle */
    .legend-toggle {
      font-size: 0.85rem;
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
      margin-top: 10px;
      display: inline-block;
    }
    .legend-content {
      display: none;
      background: #f0fdf4;
      padding: 10px;
      border-radius: 6px;
      margin-top: 5px;
      font-size: 0.8rem;
    }
    .legend-content.show { display: block; }

  </style>
</head>
<body>

  <div class="container">
    
    <!-- CABECERA -->
    <header class="header">
      <div class="brand">
        <h1>GABARRÓ</h1>
        <p>Centro de Corte y Canteado</p>
      </div>
      
      <div class="order-type">
        <label class="radio-label">
          <input type="radio" name="tipoPedido" value="Pedido" checked onchange="saveData()">
          <i data-lucide="shopping-cart"></i> Pedido
        </label>
        <label class="radio-label">
          <input type="radio" name="tipoPedido" value="Presupuesto" onchange="saveData()">
          <i data-lucide="file-text"></i> Presupuesto
        </label>
      </div>
    </header>

    <!-- FORMULARIO DATOS -->
    <div class="card">
      <div class="section-title"><i data-lucide="user"></i> Datos del Cliente</div>
      <div class="grid-form">
        <div class="form-group">
          <label>Nombre *</label>
          <input type="text" id="nombre" placeholder="Nombre completo o Empresa" oninput="saveData()">
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="email" placeholder="cliente@email.com" oninput="saveData()">
        </div>
        <div class="form-group">
          <label>Teléfono *</label>
          <input type="tel" id="telefono" placeholder="600 000 000" oninput="saveData()">
        </div>
        <div class="form-group">
          <label>Código Cliente (Opcional)</label>
          <input type="text" id="codigoCliente" oninput="saveData()">
        </div>
        <div class="form-group">
          <label>Fecha</label>
          <input type="text" id="fecha" readonly style="background: #eee; cursor: not-allowed;">
        </div>
      </div>
    </div>

    <!-- RESUMEN DE PIEZAS -->
    <div class="stats-container">
      <div class="stats-bar">
        <span><i data-lucide="calculator" style="margin-right: 8px; vertical-align: middle;"></i> Resumen Total</span>
        <div class="stats-values">
            <span id="totalPieces">0 Piezas</span>
            <span style="opacity: 0.3">|</span>
            <span id="totalArea">0.00 m²</span>
            <span style="opacity: 0.3">|</span>
            <span id="totalCanto" style="color: #a3e635;">0.00 ml Canto</span>
        </div>
      </div>
    </div>

    <!-- TABLA DE MEDIDAS -->
    <form id="corteForm">
      <div style="text-align: center; color: var(--danger); font-weight: bold; margin-bottom: 10px; font-size: 0.9rem;">
        ⚠ IMPORTANTE: El LARGO es siempre la dirección de la veta
      </div>

      <table class="table-responsive" id="dataTable">
        <thead>
          <tr>
            <th width="12%">Canteado</th>
            <th width="20%">Referencia (Etiqueta)</th>
            <th width="25%">Material</th>
            <th width="8%">Grueso</th>
            <th width="10%">Largo (mm)</th>
            <th width="10%">Ancho (mm)</th>
            <th width="8%">Uds.</th>
            <th width="7%">Acciones</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Las filas se generan con JS -->
        </tbody>
      </table>

      <!-- BOTÓN AGREGAR (GRANDE) -->
      <button type="button" class="btn btn-outline" id="addRow" style="width: 100%; margin-top: 15px; border-style: dashed; justify-content: center;">
        <i data-lucide="plus-circle"></i> Añadir Pieza
      </button>

      <!-- LEYENDA CANTEADO -->
      <div style="margin-top: 15px; text-align: right;">
        <span class="legend-toggle" onclick="toggleLegend()">¿Qué significan los códigos de canto?</span>
        <div id="legendBox" class="legend-content" style="text-align: left;">
          <strong>Leyenda:</strong> CL = Canto Largo, CA = Canto Ancho.<br>
          • <strong>1CL 1CA:</strong> Una "L" (1 Largo + 1 Ancho)<br>
          • <strong>2CL:</strong> Los dos lados largos paralelos<br>
          • <strong>4C:</strong> Todo el perímetro<br>
          • <strong>SIN CANTO:</strong> Corte crudo
        </div>
      </div>

      <!-- BOTONES FINALES -->
      <div class="action-bar">
        <button type="button" class="btn btn-danger" id="clearTableBtn" style="font-size: 0.9rem;">
          <i data-lucide="trash-2"></i> Borrar Todo
        </button>
        <button type="button" class="btn btn-primary" id="submitBtn" style="flex:1; justify-content: center; font-size: 1.1rem;">
          <i data-lucide="download"></i> Generar Excel
        </button>
      </div>
    </form>
  </div>

  <script>
    // Inicializar Iconos
    lucide.createIcons();

    // Referencias DOM
    const tableBody = document.getElementById("tableBody");
    const totalPiecesEl = document.getElementById("totalPieces");
    const totalAreaEl = document.getElementById("totalArea");
    const totalCantoEl = document.getElementById("totalCanto");

    // OPCIONES DE CANTEADO
    const cantosOptions = [
      {val: "SIN CANTO", label: "SIN CANTO"},
      {val: "1CL 1CA", label: "1 Largo + 1 Ancho (L)"},
      {val: "1CL 2CA", label: "1 Largo + 2 Anchos (U)"},
      {val: "2CL", label: "2 Largos (Paralelos)"},
      {val: "2CL 1CA", label: "2 Largos + 1 Ancho (U)"},
      {val: "1CL", label: "1 Largo Único"},
      {val: "4C", label: "4 Cantos (Perímetro)"},
      {val: "1CA", label: "1 Ancho Único"},
      {val: "2CA", label: "2 Anchos (Paralelos)"}
    ];

    document.addEventListener("DOMContentLoaded", function () {
      // Poner fecha
      document.getElementById("fecha").value = new Date().toLocaleDateString("es-ES");
      
      // Intentar cargar datos guardados
      loadData();
      
      // Si no hay filas, añadir una vacía
      if(tableBody.children.length === 0) addNewRow();
      
      updateStats();
    });

    // --- LÓGICA DE TABLA ---

    function createRowHTML(data = {}) {
        const row = document.createElement("tr");
        
        // Generar opciones del select
        let optionsHTML = `<option value="">- Selec -</option>`;
        cantosOptions.forEach(opt => {
            const selected = (data.canteado === opt.val) ? 'selected' : '';
            optionsHTML += `<option value="${opt.val}" ${selected}>${opt.val}</option>`;
        });

        row.innerHTML = `
          <td data-label="Canteado">
            <select class="input-canto" onchange="saveData(); updateStats()">${optionsHTML}</select>
          </td>
          <td data-label="Referencia">
            <input type="text" class="input-ref" value="${data.referencia || ''}" placeholder="Ej. Puerta izq" oninput="saveData()">
          </td>
          <td data-label="Material">
            <input type="text" class="input-mat" value="${data.material || ''}" placeholder="Tipo de tablero" oninput="saveData()">
          </td>
          <td data-label="Grueso">
            <input type="number" class="input-grueso" value="${data.grueso || ''}" min="0" max="100" placeholder="mm" oninput="saveData()">
          </td>
          <td data-label="Largo (mm)">
            <input type="number" class="input-largo" value="${data.largo || ''}" min="0" placeholder="0" oninput="saveData(); updateStats()">
          </td>
          <td data-label="Ancho (mm)">
            <input type="number" class="input-ancho" value="${data.ancho || ''}" min="0" placeholder="0" oninput="saveData(); updateStats()">
          </td>
          <td data-label="Unidades">
            <input type="number" class="input-uds" value="${data.unidades || '1'}" min="1" oninput="saveData(); updateStats()">
          </td>
          <td data-label="Acciones">
            <div style="display:flex; justify-content:flex-end; gap:5px;">
                <button type="button" class="btn-icon btn-copy" title="Duplicar" onclick="duplicateRow(this)">
                    <i data-lucide="copy" width="18" height="18"></i>
                </button>
                <button type="button" class="btn-icon btn-delete" title="Eliminar" onclick="deleteRow(this)">
                    <i data-lucide="trash" width="18" height="18"></i>
                </button>
            </div>
          </td>
        `;
        return row;
    }

    function addNewRow(data = {}) {
      const row = createRowHTML(data);
      tableBody.appendChild(row);
      lucide.createIcons(); // Recargar iconos para los nuevos botones
      updateStats();
      saveData();
    }

    document.getElementById("addRow").addEventListener("click", () => addNewRow());

    window.deleteRow = function(btn) {
      if(confirm("¿Borrar esta línea?")) {
        btn.closest("tr").remove();
        saveData();
        updateStats();
      }
    };

    window.duplicateRow = function(btn) {
      const tr = btn.closest("tr");
      const data = {
        canteado: tr.querySelector(".input-canto").value,
        referencia: tr.querySelector(".input-ref").value,
        material: tr.querySelector(".input-mat").value,
        grueso: tr.querySelector(".input-grueso").value,
        largo: tr.querySelector(".input-largo").value,
        ancho: tr.querySelector(".input-ancho").value,
        unidades: tr.querySelector(".input-uds").value
      };
      addNewRow(data);
    };

    document.getElementById("clearTableBtn").addEventListener("click", function() {
      if(confirm("¿Estás seguro de vaciar toda la tabla?")) {
        tableBody.innerHTML = "";
        addNewRow(); // Añadir una limpia
        localStorage.removeItem("gabarroData");
        updateStats();
      }
    });

    // --- CÁLCULOS Y ESTADÍSTICAS ---
    function updateStats() {
      let totalP = 0;
      let totalM2 = 0;
      let totalML = 0; // Total metros lineales de canto

      const rows = tableBody.querySelectorAll("tr");
      rows.forEach(row => {
        const uds = parseInt(row.querySelector(".input-uds").value) || 0;
        const largoMm = parseFloat(row.querySelector(".input-largo").value) || 0;
        const anchoMm = parseFloat(row.querySelector(".input-ancho").value) || 0;
        const cantoType = row.querySelector(".input-canto").value;

        // Convertir a metros para cálculos
        const largoM = largoMm / 1000;
        const anchoM = anchoMm / 1000;

        totalP += uds;
        // Calculo mm a metros cuadrados: (L * A / 1,000,000) * Uds
        totalM2 += (largoM * anchoM) * uds;

        // Cálculo de Metros Lineales de Canto según selección
        let mlPerPiece = 0;
        switch(cantoType) {
            case "1CL 1CA": mlPerPiece = largoM + anchoM; break;
            case "1CL 2CA": mlPerPiece = largoM + (anchoM * 2); break;
            case "2CL":     mlPerPiece = largoM * 2; break;
            case "2CL 1CA": mlPerPiece = (largoM * 2) + anchoM; break;
            case "1CL":     mlPerPiece = largoM; break;
            case "4C":      mlPerPiece = (largoM * 2) + (anchoM * 2); break;
            case "1CA":     mlPerPiece = anchoM; break;
            case "2CA":     mlPerPiece = anchoM * 2; break;
            default:        mlPerPiece = 0; // SIN CANTO o vacío
        }
        totalML += mlPerPiece * uds;
      });

      totalPiecesEl.textContent = `${totalP} Piezas`;
      totalAreaEl.textContent = `${totalM2.toFixed(2)} m²`;
      if(totalCantoEl) {
          totalCantoEl.textContent = `${totalML.toFixed(2)} ml Canto`;
      }
    }

    // --- LOCAL STORAGE (AUTOGUARDADO) ---
    window.saveData = function() {
        const formData = {
            nombre: document.getElementById("nombre").value,
            email: document.getElementById("email").value,
            telefono: document.getElementById("telefono").value,
            codigo: document.getElementById("codigoCliente").value,
            tipo: document.querySelector('input[name="tipoPedido"]:checked').value,
            items: []
        };

        const rows = tableBody.querySelectorAll("tr");
        rows.forEach(row => {
            formData.items.push({
                canteado: row.querySelector(".input-canto").value,
                referencia: row.querySelector(".input-ref").value,
                material: row.querySelector(".input-mat").value,
                grueso: row.querySelector(".input-grueso").value,
                largo: row.querySelector(".input-largo").value,
                ancho: row.querySelector(".input-ancho").value,
                unidades: row.querySelector(".input-uds").value
            });
        });

        localStorage.setItem("gabarroData", JSON.stringify(formData));
    };

    function loadData() {
        const saved = localStorage.getItem("gabarroData");
        if(saved) {
            try {
                const data = JSON.parse(saved);
                document.getElementById("nombre").value = data.nombre || "";
                document.getElementById("email").value = data.email || "";
                document.getElementById("telefono").value = data.telefono || "";
                document.getElementById("codigoCliente").value = data.codigo || "";
                
                if(data.tipo) {
                    const radio = document.querySelector(`input[name="tipoPedido"][value="${data.tipo}"]`);
                    if(radio) radio.checked = true;
                }

                if(data.items && data.items.length > 0) {
                    tableBody.innerHTML = ""; // Limpiar tabla por defecto
                    data.items.forEach(item => addNewRow(item));
                }
            } catch(e) {
                console.error("Error cargando datos", e);
            }
        }
    }

    // --- LEYENDA TOGGLE ---
    window.toggleLegend = function() {
        document.getElementById("legendBox").classList.toggle("show");
    }

    // --- EXCEL GENERATION ---
    document.getElementById("submitBtn").addEventListener("click", function () {
        const nombre = document.getElementById("nombre").value.trim();
        const email = document.getElementById("email").value.trim();
        const telefono = document.getElementById("telefono").value.trim();
        const codigo = document.getElementById("codigoCliente").value.trim();
        
        // Validación básica
        if (!nombre || !telefono) {
            alert("Por favor, indica al menos el Nombre y Teléfono.");
            return;
        }

        const tipo = document.querySelector('input[name="tipoPedido"]:checked').value;
        const fecha = document.getElementById("fecha").value;

        // Estructura de datos para Excel
        const dataRows = [
            ["FORMULARIO DE PRODUCCIÓN", ""],
            ["Tipo Solicitud:", tipo],
            ["Fecha:", fecha],
            ["Cliente:", nombre],
            ["Email:", email],
            ["Teléfono:", telefono],
            ["Cód. Cliente:", codigo],
            [], // Espacio
            ["Canteado", "Referencia", "Material", "Grueso", "Largo (mm)", "Ancho (mm)", "Unidades"] // Cabecera Tabla
        ];

        // Obtener datos de la tabla HTML
        const rows = tableBody.querySelectorAll("tr");
        let hasData = false;

        rows.forEach(row => {
            const mat = row.querySelector(".input-mat").value;
            const lar = row.querySelector(".input-largo").value;
            const anc = row.querySelector(".input-ancho").value;
            const uds = row.querySelector(".input-uds").value;

            // Solo añadir si hay datos mínimos
            if(mat || (lar && anc)) {
                hasData = true;
                dataRows.push([
                    row.querySelector(".input-canto").value,
                    row.querySelector(".input-ref").value,
                    mat,
                    row.querySelector(".input-grueso").value,
                    lar,
                    anc,
                    uds
                ]);
            }
        });

        if(!hasData) {
            alert("La tabla está vacía. Añade al menos una medida.");
            return;
        }

        // Generar Libro
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(dataRows);
        
        // Ajustar anchos de columna (Visualización Excel)
        ws['!cols'] = [
            { wch: 15 }, // Canteado
            { wch: 25 }, // Ref
            { wch: 30 }, // Material
            { wch: 8 },  // Grueso
            { wch: 10 }, // Largo
            { wch: 10 }, // Ancho
            { wch: 8 }   // Uds
        ];

        XLSX.utils.book_append_sheet(wb, ws, "Produccion");

        // Nombre archivo limpio
        const cleanName = nombre.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const fileName = `Gabarro_${tipo}_${cleanName}.xlsx`;

        XLSX.writeFile(wb, fileName);
    });

  </script>
</body>
</html>
